"use client";

import AttendanceTable from "@/components/AttendanceTable";
import ClockStatusCard from "@/components/ClockStatusCard";
import ControlButtons from "@/components/ControlButtons";
import { useState, useEffect } from "react";

interface AttendanceData {
  employee_name: string;
}

type BreakTime = {
  break_in: string;
  break_out: string;
};

type AttendanceRow = {
  employee_name: string;
  date: string;
  time_in: string;
  time_out: string;
  total_hours: string;
  late: boolean;
  halfDay: boolean;
  shortShift: boolean
  breaks: BreakTime[];
  total_break_time: string;
};


export default function Dashboard() {
  const SHIFT_SECONDS = 9 * 60 * 60;
  const BREAK_LIMIT_SECONDS = 60 * 60;

  const [clockedIn, setClockedIn] = useState(false);
  const [startTime, setStartTime] = useState<number | null>(null);
  const [elapsedSeconds, setElapsedSeconds] = useState(0);

  const [onBreak, setOnBreak] = useState(false);
  const [breakStartTime, setBreakStartTime] = useState<number | null>(null);
  const [totalBreakSeconds, setTotalBreakSeconds] = useState(0);

  useEffect(() => {
    if (typeof window !== "undefined") {
      const saved = localStorage.getItem("totalBreakSeconds");
      if (saved) {
        setTotalBreakSeconds(parseInt(saved, 10));
      }
    }
  }, []);


  const [isCheckOut, setIsCheckOut] = useState(false)

  const [attendanceData, setAttendanceData] = useState([])


  const downloadCsv = (attendanceData: AttendanceRow[]) => {
    const headers = [
      "Index",
      "Employee",
      "Date",
      "Time In",
      "Time Out",
      "Total Hours",
      "Break In & Break Out",
      "Break Time",
      "Late",
      "Short Shift",
      "Half Day"
    ];

    const rows = attendanceData.map((row, index) => {
      const breakDetails = row.breaks
        .map(b => `${b.break_in} / ${b.break_out}`)
        .join(" | ");

      return [
        index + 1,
        row.employee_name,
        row.date,
        row.time_in,
        row.time_out,
        row.total_hours,
        breakDetails,
        row.total_break_time,
        row.late ? "Yes" : "No",
        row.shortShift ? "Yes" : "No",
        row.halfDay ? "Yes" : "No",
      ];
    });

    const csvContent =
      "data:text/csv;charset=utf-8," +
      [headers, ...rows]
        .map(e => e.map(String).map(v => `"${v}"`).join(","))
        .join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "attendance.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };


  useEffect(() => {
    const interval = setInterval(() => {
      checkStatus();
    }, 30000);

    checkStatus();
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    localStorage.setItem("totalBreakSeconds", totalBreakSeconds.toString());
  }, [totalBreakSeconds]);


  const checkStatus = async () => {
    try {
      const res = await fetch(
        "https://ukashacoder.pythonanywhere.com/api/attendance/status/",
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access")}`,
          },
        }
      );
      const data = await res.json();

      if (res.ok) {
        switch (data.status) {
          case "checked_in":
            setClockedIn(true);
            setIsCheckOut(false);

            const utcDate = new Date(data.time_in);
            const localTime =
              utcDate.getTime() - utcDate.getTimezoneOffset() * 60 * 1000;
            setStartTime(localTime);

            const elapsed = Math.floor((Date.now() - localTime) / 1000);
            setElapsedSeconds(elapsed);

            if (elapsed >= 36000 && !isCheckOut) {
              console.log("⏳ Auto-checkout triggered after 10 hours");
              await handleCheckOut();
            }
            break;

          case "checked_out":
            setClockedIn(false);
            setIsCheckOut(true);
            break;

          default:
            setClockedIn(false);
            setIsCheckOut(false);
        }
      }
    } catch (err) {
      console.log("Error checking status", err);
    }
  };

  useEffect(() => {
    if (!clockedIn || !startTime) return;
    const interval = setInterval(() => {
      setElapsedSeconds(Math.floor((Date.now() - startTime) / 1000));
    }, 1000);
    return () => clearInterval(interval);
  }, [clockedIn, startTime]);

  useEffect(() => {
    let interval: any;
    if (onBreak && breakStartTime && !isCheckOut) {
      interval = setInterval(() => {
        setTotalBreakSeconds((prev) => prev + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [onBreak, breakStartTime, isCheckOut]);

  const handleCheckIn = async () => {
    try {
      const res = await fetch(
        "https://ukashacoder.pythonanywhere.com/api/attendance/time-in/",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access")}`,
          },
        }
      );

      const data = await res.json();

      if (res.ok) {
        const now = Date.now();

        localStorage.setItem("checkedIn", "true");
        localStorage.setItem("checkInTime", now.toString());
        // Reset break time when checking in for a new day
        setTotalBreakSeconds(0);
        localStorage.setItem("totalBreakSeconds", "0");

        setClockedIn(true);
        setStartTime(now);

        console.log("✅ Clocked in at", new Date(now).toLocaleString());
      } else {
        alert(data.error || "Error in time in");
      }
    } catch (error) {
      console.error("Check-in failed:", error);
      alert("Failed to check in");
    }
  };


  useEffect(() => {
    const alreadyCheckedIn = localStorage.getItem("checkedIn") === "true";

    if (alreadyCheckedIn) {
      const savedTime = localStorage.getItem("checkInTime");
      if (savedTime) {
        setClockedIn(true);
        setStartTime(Number(savedTime));
        setElapsedSeconds(Math.floor((Date.now() - Number(savedTime)) / 1000));
      }
      return;
    }

    checkStatus();
  }, []);

  useEffect(() => {
  const savedTotalBreak = parseInt(localStorage.getItem("totalBreakSeconds") || "0", 10);
  const savedOnBreak = localStorage.getItem("onBreak") === "true";
  const savedBreakStart = localStorage.getItem("breakStartTime");

  if (savedOnBreak && savedBreakStart) {
    const now = Date.now();
    const diff = Math.floor((now - Number(savedBreakStart)) / 1000);
    setTotalBreakSeconds(savedTotalBreak + diff);
    setOnBreak(true);
    setBreakStartTime(Number(savedBreakStart));
  } else {
    setTotalBreakSeconds(savedTotalBreak);
  }
}, []);


  const handleCheckOut = async () => {
    try {
      if (onBreak) {
        await handleBreakOut();
      }
      const res = await fetch(
        "https://ukashacoder.pythonanywhere.com/api/attendance/time-out/",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access")}`,
          },
        }
      );
      const data = await res.json();
      if (res.ok) {
        localStorage.removeItem("checkedIn");
        localStorage.removeItem("checkInTime");
        // Only reset totalBreakSeconds when actually checking out
        localStorage.setItem("totalBreakSeconds", "0");
        setClockedIn(false);
        setStartTime(null);
        setElapsedSeconds(0);
        setTotalBreakSeconds(0);
        setOnBreak(false);
        setBreakStartTime(null);
        setIsCheckOut(true)
      } else {
        alert(data.error || "Error in time out");
      }
    } catch {
      alert("Failed to check out");
    }
  };

  const handleBreakIn = async () => {
    try {
      const res = await fetch(
        "https://ukashacoder.pythonanywhere.com/api/attendance/break-in/",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("access")}`,
          },
          body: JSON.stringify({ employee_id: localStorage.getItem("employee_id") })
        }
      );

      const data = await res.json();

      if (res.ok) {
        const now = Date.now();
        setOnBreak(true);
        setBreakStartTime(now);

        localStorage.setItem("onBreak", "true");
        localStorage.setItem("breakStartTime", now.toString());

        console.log("☕ Break In at", new Date(now).toLocaleString());
      } else {
        alert(data.message || data.error || "Error in break in");
      }
    } catch (error) {
      console.error(error);
      alert("Failed to mark break in");
    }
  };

  const handleBreakOut = async () => {
    try {
      const res = await fetch(
        "https://ukashacoder.pythonanywhere.com/api/attendance/break-out/",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("access")}`,
          },
          body: JSON.stringify({ employee_id: localStorage.getItem("employee_id") })
        }
      );

      const data = await res.json();

      if (res.ok) {
        setOnBreak(false);
        setBreakStartTime(null);
        localStorage.removeItem("onBreak");
        localStorage.removeItem("breakStartTime");
        localStorage.setItem("totalBreakSeconds", totalBreakSeconds.toString()); // save on break end
      } else {
        alert(data.message || data.error || "Error in break out");
      }
    } catch (error) {
      console.error(error);
      alert("Failed to mark break out");
    }
  };



  useEffect(() => {
    const fetchAttendanceData = async () => {
      try {
        const res = await fetch(
          'https://ukashacoder.pythonanywhere.com/api/attendance/',
          {
            method: "GET",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("access")}`,
            },
          }
        )
        const data = await res.json();
        console.log(data)
        setAttendanceData(data);

        if (data.length > 0) {
          const todayRecord = data[0];

          const [h, m, s] = todayRecord.total_break_time.split(":").map(Number);
          let totalSeconds = h * 3600 + m * 60 + s;

          if (todayRecord.breaks.length > 0) {
            const lastBreak = todayRecord.breaks[todayRecord.breaks.length - 1];
            if (lastBreak.break_out === null) {
              const breakStart = new Date(lastBreak.break_in).getTime();
              const now = Date.now();
              totalSeconds += Math.floor((now - breakStart) / 1000);

              setOnBreak(true);
              setBreakStartTime(breakStart);
              localStorage.setItem("onBreak", "true");
              localStorage.setItem("breakStartTime", breakStart.toString());
            }
          }

          setTotalBreakSeconds(totalSeconds);
          localStorage.setItem("totalBreakSeconds", totalSeconds.toString()); // persist after fetch
        }
      } catch (err) {
        console.log(err);
      }
    };

    fetchAttendanceData();
  }, [isCheckOut, setOnBreak]);


  useEffect(() => {
    const onBreakStored = localStorage.getItem("onBreak") === "true";
    if (onBreakStored) {
      const storedBreakStart = localStorage.getItem("breakStartTime");
      if (storedBreakStart) {
        setOnBreak(true);
        setBreakStartTime(Number(storedBreakStart));
      }
    }
  }, []);


  const formatTime = (seconds: number) => {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${String(hrs).padStart(2, "0")}:${String(mins).padStart(
      2,
      "0"
    )}:${String(secs).padStart(2, "0")}`;
  };

  return (
    <main className="w-full h-full flex flex-col gap-4 items-center justify-start bg-[#141D38] py-8 px-4">
      <ClockStatusCard
        elapsedSeconds={elapsedSeconds}
        totalBreakSeconds={totalBreakSeconds}
        shiftSeconds={SHIFT_SECONDS}
        breakLimitSeconds={BREAK_LIMIT_SECONDS}
        formatTime={formatTime}
      />
      <section className="flex items-center justify-between max-w-[1140px] w-full text-white mt-40">

        <div>
          {attendanceData.map((item: AttendanceData, index: number) =>
            index === 0 && (
              <span key={index}>Welcome {item.employee_name}</span>
            ))}
        </div>

        <div className="flex">
          {
            isCheckOut ? (
              <span className="text-gray-400">You are clocked out</span>
            ) : !clockedIn ? (
              <button onClick={handleCheckIn} className="bg-blue-500 text-white px-4 py-2 rounded">
                Check In
              </button>
            ) : (
              <ControlButtons
                onBreak={onBreak}
                clockedIn={clockedIn}
                handleBreakIn={handleBreakIn}
                handleBreakOut={handleBreakOut}
                handleCheckOut={handleCheckOut}
              />
            )
          }
        </div>

      </section>
      <section className="max-w-[1140px] w-full bg-white h-full p-6 rounded-lg">
        <AttendanceTable attendanceData={attendanceData} />
        <button className="mt-4 flex items-center justify-between bg-[#141D38] p-2 rounded-sm text-white text-sm font-light" onClick={() => downloadCsv(attendanceData)}>Download Sheet</button>
      </section>
    </main>
  );
}